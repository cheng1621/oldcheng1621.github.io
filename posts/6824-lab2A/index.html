<!DOCTYPE html><html lang="en" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="6.824 Lab2A" /><meta property="og:locale" content="en" /><meta name="description" content="Preparation. Raft paper" /><meta property="og:description" content="Preparation. Raft paper" /><link rel="canonical" href="https://cheng1621.github.io//posts/6824-lab2A/" /><meta property="og:url" content="https://cheng1621.github.io//posts/6824-lab2A/" /><meta property="og:site_name" content="HelloBen" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-05T10:59:10+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="6.824 Lab2A" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheng1621.github.io//posts/6824-lab2A/"},"description":"Preparation. Raft paper","url":"https://cheng1621.github.io//posts/6824-lab2A/","@type":"BlogPosting","headline":"6.824 Lab2A","dateModified":"2020-12-05T10:59:10+08:00","datePublished":"2020-12-05T10:59:10+08:00","@context":"https://schema.org"}</script><title>6.824 Lab2A | HelloBen</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="HelloBen"><meta name="application-name" content="HelloBen"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/android-chrome-192x192.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">HelloBen</a></div><div class="site-subtitle font-italic">Keeping Trying</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/cheng1621" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['subencheng','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>6.824 Lab2A</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>6.824 Lab2A</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> BenchengSu </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Dec 5, 2020, 10:59 AM +0800" >Dec 5, 2020<i class="unloaded">2020-12-05T10:59:10+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="606 words">3 min read</span></div></div><div class="post-content"><h1 id="preparation">Preparation.</h1><ul><li><a href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf">Raft paper</a></ul><h1 id="summary">Summary.</h1><p>There is only one leader in Raft algorithm. Leader remains authority through sending <code class="language-plaintext highlighter-rouge">AppendEntries</code> to peers. if one peer doesn’t hear from the leader or Candidate, it starts election through sending <code class="language-plaintext highlighter-rouge">RequestVote</code> to other peers, if Candidate gain majority of Votes from peers and it would become leader and send <code class="language-plaintext highlighter-rouge">AppendEntries</code> to other peers.</p><h1 id="some-details">Some details.</h1><ol><li>if there is already one leader in raft, and for some unpredicted reason, <code class="language-plaintext highlighter-rouge">AppendEntries</code> is failed and other peers does not receive that signal, based on Raft algorithm, the peer would become Candidate and start election. If that peer eventually becomes Leader and the old leader comes back to work. There is a conflict here. My thought is change the old leader to Follower again through <code class="language-plaintext highlighter-rouge">rf.currentTerm</code>.<li>if more than one Followers change to Candidate at the same time, called <strong>split vote</strong>. Raft use random timeout for different servers. In this case, only one candidate could start election eventually through increasing <strong>currentTerm</strong>.<li>test code with <code class="language-plaintext highlighter-rouge">go test -run 2A</code>. try it with more than 1 time. For me, I try it 10 times to guarantee the code is running successfully always.</ol><h1 id="hint">Hint:</h1><ol><li>go test -run 2A. Done.<li>focus on 3 things. <strong>RequestVote</strong>, <strong>Rules for servers</strong> and <strong>State</strong> related to leader election.<ul><li>Follower<br /> Task: update time when receiving signal from Candidates or Leader. If not, becomes Candidates and start election.<li>Candidates<br /> send <code class="language-plaintext highlighter-rouge">RequestVote</code> to peers and gain Votes.<li>Leader<br /> Send <code class="language-plaintext highlighter-rouge">AppendEntries</code> to other peers. Remember to change ole Leader to Follower if there is more than one Leader.<li>new to raft</ul></ol><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>type Raft struct {
	mu        sync.Mutex          // Lock to protect shared access to this peer's state
	peers     []*labrpc.ClientEnd // RPC end points of all peers
	persister *Persister          // Object to hold this peer's persisted state
	me        int                 // this peer's index into peers[]
	dead      int32               // set by Kill()

	// Your data here (2A, 2B, 2C).
	// Look at the paper's Figure 2 for a description of what
	// state a Raft server must maintain.
	// (new).
	state int
	Time time.Time
	VoteCount int
	Timeout int
	// (new) end

	currentTerm int
	VoteFor int
	log []LogEntry

	commitIndex int
	lastApplied int
	
	nextIndex []int
	matchIndex []int
}
</pre></table></code></div></div><ul><li>RequestVote:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>type RequestVoteArgs struct {
  // Your data here (2A, 2B).
  Term int
  CandidateId int 
  LastLogIndex int
  LastLogTerm int
}
type RequestVoteReply struct {
  // Your data here (2A).
  Term int
  VoteGranted bool
}
//
func (rf *Raft) RequestVote(args *RequestVoteArgs, reply *RequestVoteReply){
  // Your code here (2A, 2B).
  rf.mu.Lock()
  rf.Time = time.Now()
  rf.mu.Unlock()
  if args.Term &lt; rf.currentTerm {
      reply.VoteGranted = false;
  }
  if rf.VoteFor == -1 || rf.VoteFor == args.CandidateId {
      reply.VoteGranted = true
  }
  if args.Term &gt; rf.currentTerm{
      rf.mu.Lock()
      rf.currentTerm = args.Term
      rf.mu.Unlock()
      rf.convertToFollower()
      DPrintf("%d converts to follower",rf.me)
  }
}
</pre></table></code></div></div><li>AppendEntries</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>type AppendEntriesArgs struct {
	Term int
	LeaderId int
	PrevLogIndex int
	PrevLogTerm int
	Entries []LogEntry
	LeaderCommit int
}
type AppendEntriesReply struct {
	Term int
	Success bool
}

// (2A) AppendEntries Handler.
func (rf *Raft) AppendEntries(args *AppendEntriesArgs, reply *AppendEntriesReply){
	if args.Term &lt; rf.currentTerm {
		reply.Success = false
	}else{
		rf.convertToFollower()
		reply.Success = true
	}
	rf.Time = time.Now()
}

</pre></table></code></div></div><ol><li>Timeout. <code class="language-plaintext highlighter-rouge">rf.Timeout = rand.Intn(150) + 150</code> range[150,300]<li>Update time. <code class="language-plaintext highlighter-rouge">tf.Time = time.Now()</code></ol><h1 id="result">Result</h1><p><img data-proofer-ignore data-src="https://raw.githubusercontent.com/cheng1621/HelloMike.github.io/master/assets/img/sample/6824_lab2A_result.png" alt="Result" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/distributed-system/'>Distributed System</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/distributed-system/" class="post-tag no-text-decoration" >Distributed System</a> <a href="/tags/raft/" class="post-tag no-text-decoration" >Raft</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=6.824 Lab2A - HelloBen&url=https://cheng1621.github.io//posts/6824-lab2A/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=6.824 Lab2A - HelloBen&u=https://cheng1621.github.io//posts/6824-lab2A/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=6.824 Lab2A - HelloBen&url=https://cheng1621.github.io//posts/6824-lab2A/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/amazon_leadership/">Amazon bq question</a><li><a href="/posts/OOD_Design/">Design Parking Lot</a><li><a href="/posts/fault-tolerant-system/">6.824 (假设能拿到offer的项目）</a><li><a href="/posts/lowLatency_MultiDatacenter_Databases_Using_Replicated_Commit/">Low-Latency Multi-Datacenter Databases using Replicated Commit Note</a><li><a href="/posts/Frangipani/">frangipani</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/distributed-system/">Distributed System</a> <a class="post-tag" href="/tags/raft/">Raft</a> <a class="post-tag" href="/tags/large-scale-software-engineering/">Large Scale Software Engineering</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/amazon/">Amazon</a> <a class="post-tag" href="/tags/aurora/">Aurora</a> <a class="post-tag" href="/tags/craq/">CRAQ</a> <a class="post-tag" href="/tags/frangipani/">frangipani</a> <a class="post-tag" href="/tags/gfs/">gfs</a> <a class="post-tag" href="/tags/kvservice/">kvservice</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/fault-tolerant-system/"><div class="card-body"> <span class="timeago small" >Jun 1, 2021<i class="unloaded">2021-06-01T19:10:10+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>6.824 (假设能拿到offer的项目）</h3><div class="text-muted small"><p> 1.先来个自我介绍吧。 嗯嗯，我之前写过一个基于LLVM的小型编译器，写过一个小型操作系统的kernel，最近写过一个有关分布式系统的，这个分布式系统实际上就是一个可容错性的分布式key/value数据库，支持动态扩容，负载均衡，线性一致性，这个一致性是基于raft共识算法，嗯，raft 就是为了在不同的服务器保持一致性的一种算法。这个数据库支持一定的容错，就是一个服务器崩了，另一个服务器马...</p></div></div></a></div><div class="card"> <a href="/posts/6824-lab2B/"><div class="card-body"> <span class="timeago small" >Dec 26, 2020<i class="unloaded">2020-12-26T01:21:10+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>6.824 Lab2B</h3><div class="text-muted small"><p> Preparation. Raft paper Raft Explanation Some details about Raft Explanation.(the link above) Actually, I know the big picture of the Raft consenus algorithm from the link above. Then I impl...</p></div></div></a></div><div class="card"> <a href="/posts/6824-lab2C/"><div class="card-body"> <span class="timeago small" >Dec 28, 2020<i class="unloaded">2020-12-28T21:24:10+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>6.824 Lab2C</h3><div class="text-muted small"><p> Summary. I am a new programmer in Go languare. I spent almost 1 month implementing this lab2. Actually, I spent most of the time on debugging, just because I do not know much about Go. For example,...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/firstPost/" class="btn btn-outline-primary" prompt="Older"><p>6.824 Lab1 MapReduce</p></a> <a href="/posts/6824-lab2B/" class="btn btn-outline-primary" prompt="Newer"><p>6.824 Lab2B</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">BenchengSu</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/distributed-system/">Distributed System</a> <a class="post-tag" href="/tags/raft/">Raft</a> <a class="post-tag" href="/tags/large-scale-software-engineering/">Large Scale Software Engineering</a> <a class="post-tag" href="/tags/design-pattern/">Design Pattern</a> <a class="post-tag" href="/tags/amazon/">Amazon</a> <a class="post-tag" href="/tags/aurora/">Aurora</a> <a class="post-tag" href="/tags/craq/">CRAQ</a> <a class="post-tag" href="/tags/frangipani/">frangipani</a> <a class="post-tag" href="/tags/gfs/">gfs</a> <a class="post-tag" href="/tags/kvservice/">kvservice</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
